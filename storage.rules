
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Legacy path - user-scoped image storage
    // Path structure: quiz-images/{userId}/{imageId}
    // Users can only write to their own directory
    match /quiz-images/{userId}/{allPaths=**} {
      // Anyone can read quiz images (for display during games)
      allow read;

      // Only the owner can write/delete their own images
      // Security: Prevents users from modifying other users' images
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // New quiz-specific storage structure
    // Path: quizzes/{quizId}/questions/{questionIndex}/image
    match /quizzes/{quizId}/questions/{questionIndex}/{imageName} {
      // Anyone can read quiz images
      allow read;

      // Only the quiz owner can write/delete images
      // This is checked via Firestore lookup
      allow write: if request.auth != null &&
                     request.auth.uid == firestore.get(/databases/(default)/documents/quizzes/$(quizId)).data.hostId;
    }
  }
}
