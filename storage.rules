
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Legacy path - user-scoped image storage
    // Path structure: quiz-images/{userId}/{imageId}
    // Users can only write to their own directory
    match /quiz-images/{userId}/{allPaths=**} {
      // Anyone can read quiz images (for display during games)
      allow read;

      // Only the owner can write/delete their own images
      // Security: Prevents users from modifying other users' images
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // New quiz-specific storage structure
    // Path: quizzes/{quizId}/questions/{questionIndex}/image
    match /quizzes/{quizId}/questions/{questionIndex}/{imageName} {
      // Anyone can read quiz images
      allow read;

      // Only the quiz owner can write/delete images
      // This is checked via Firestore lookup
      allow write: if request.auth != null &&
                     request.auth.uid == firestore.get(/databases/(default)/documents/quizzes/$(quizId)).data.hostId;
    }

    // Temporary AI-generated images (before quiz is saved)
    // Path: temp/{tempId}/questions/{questionIndex}/image.png
    // These are created by Cloud Function and read/deleted by authenticated users
    match /temp/{tempId}/questions/{questionIndex}/{imageName} {
      // Anyone can read temp images (needed for preview in form)
      // Temp images have TTL metadata and can be cleaned up by scheduled function
      allow read;

      // Authenticated users can delete temp images (during save or cleanup)
      // The tempId is client-generated, so we allow any authenticated user to clean up
      // Cloud Function handles writes, so no write rule needed from client
      allow delete: if request.auth != null;
    }

    // Presentation slide images
    // Path: presentations/{presentationId}/slides/{slideId}/{imageName}
    match /presentations/{presentationId}/slides/{slideId}/{imageName} {
      // Anyone can read presentation images (needed for display during games)
      allow read;

      // Only the presentation owner can write/delete images
      allow write: if request.auth != null &&
                      request.auth.uid == firestore.get(/databases/(default)/documents/presentations/$(presentationId)).data.hostId;
    }

    // Presentation content images (for rating items, etc.)
    // Path: presentations/{presentationId}/content/{imageName}
    match /presentations/{presentationId}/content/{imageName} {
      // Anyone can read presentation content images
      allow read;

      // Only the presentation owner can write/delete images
      allow write: if request.auth != null &&
                      request.auth.uid == firestore.get(/databases/(default)/documents/presentations/$(presentationId)).data.hostId;
    }
  }
}
