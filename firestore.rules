rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Protect user profiles - only the user can access their profile
    match /users/{userId} {
      allow read, update, create: if request.auth.uid == userId;
    }

    // Helper function to check if user has quiz access via share
    function hasQuizAccess(quizId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/quizzes/$(quizId)/shares/$(request.auth.token.email));
    }

    // CollectionGroup rule for querying shares across all quizzes
    match /{path=**}/shares/{shareId} {
      // Allow authenticated users to read shares where sharedWith matches their email
      allow read: if request.auth != null &&
                    resource.data.sharedWith == request.auth.token.email;
    }

    // Quizzes can be read by anyone, but only managed by their owner
    match /quizzes/{quizId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.hostId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.hostId;

      // Quiz shares subcollection
      // Note: shareId is the email address for efficient exists() checks
      match /shares/{shareId} {
        // Owner can read all shares for their quiz
        // Recipient can read shares where sharedWith matches their email
        allow read: if request.auth != null &&
                      (request.auth.uid == get(/databases/$(database)/documents/quizzes/$(quizId)).data.hostId ||
                       request.auth.token.email == resource.data.sharedWith);

        // Only quiz owner can create shares
        // Document ID (shareId) must match the sharedWith email
        allow create: if request.auth != null &&
                        request.auth.uid == get(/databases/$(database)/documents/quizzes/$(quizId)).data.hostId &&
                        request.resource.data.sharedBy == request.auth.uid &&
                        request.resource.data.quizId == quizId &&
                        shareId == request.resource.data.sharedWith;

        // Owner can delete their shares, recipient can also delete (to cancel)
        allow delete: if request.auth != null &&
                        (request.auth.uid == resource.data.sharedBy ||
                         request.auth.token.email == resource.data.sharedWith);
      }
    }

    // Game sessions
    match /games/{gameId} {
      // Anyone can read game state
      allow read: if true;

      // Authenticated hosts can create games for their own quizzes OR shared quizzes
      allow create: if request.auth != null &&
                      request.auth.uid == request.resource.data.hostId &&
                      (request.auth.uid == get(/databases/$(database)/documents/quizzes/$(request.resource.data.quizId)).data.hostId ||
                       hasQuizAccess(request.resource.data.quizId));

      // Only the host can update or delete the game
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.hostId;

      // Player data within a game
      match /players/{playerId} {
        // Anyone can read player data for leaderboards
        allow read: if true;

        // Only allow creating player with initial score of 0
        allow create: if request.resource.data.score == 0 &&
                        request.resource.data.id == playerId &&
                        request.resource.data.name is string &&
                        request.resource.data.name.size() >= 2 &&
                        request.resource.data.name.size() <= 20;

        // Players can ONLY update answer fields to null (resetting between questions)
        // Score updates are handled by Cloud Functions only
        // Allow updating: lastAnswerIndex (legacy/single choice), lastAnswerIndices (multi-choice), lastSliderValue (slider)
        allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastAnswerIndex', 'lastAnswerIndices', 'lastSliderValue']) &&
                        (request.resource.data.get('lastAnswerIndex', null) == null || request.resource.data.get('lastAnswerIndex', null) is int) &&
                        (request.resource.data.get('lastAnswerIndices', null) == null || request.resource.data.get('lastAnswerIndices', null) is list) &&
                        (request.resource.data.get('lastSliderValue', null) == null || request.resource.data.get('lastSliderValue', null) is number);

        // Players cannot be deleted
        allow delete: if false;
      }
    }
  }
}
