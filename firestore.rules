rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Protect user profiles - only the user can access their profile
    match /users/{userId} {
      // Users can read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can update their profile, but cannot modify protected fields
      allow update: if request.auth != null &&
                      request.auth.uid == userId &&
                      // Prevent modification of critical fields
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['email', 'emailVerified', 'id', 'createdAt']);

      // User creation is handled by Cloud Functions only
      // Cloud Functions use Admin SDK which bypasses these rules
      allow create: if false;

      // Users cannot delete their own profile
      allow delete: if false;
    }

    // Helper function to check if user has quiz access via share
    function hasQuizAccess(quizId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/quizzes/$(quizId)/shares/$(request.auth.token.email));
    }

    // CollectionGroup rule for querying shares across all quizzes
    match /{path=**}/shares/{shareId} {
      // Allow authenticated users to read shares where sharedWith matches their email
      allow read: if request.auth != null &&
                    resource.data.sharedWith == request.auth.token.email;
    }

    // Quizzes can be read by anyone, but only managed by their owner
    match /quizzes/{quizId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.hostId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.hostId;

      // Quiz shares subcollection
      // Note: shareId is the email address for efficient exists() checks
      match /shares/{shareId} {
        // Owner can read all shares for their quiz
        // Recipient can read shares where sharedWith matches their email
        allow read: if request.auth != null &&
                      (request.auth.uid == get(/databases/$(database)/documents/quizzes/$(quizId)).data.hostId ||
                       request.auth.token.email == resource.data.sharedWith);

        // Only quiz owner can create shares
        // Document ID (shareId) must match the sharedWith email
        allow create: if request.auth != null &&
                        request.auth.uid == get(/databases/$(database)/documents/quizzes/$(quizId)).data.hostId &&
                        request.resource.data.sharedBy == request.auth.uid &&
                        request.resource.data.quizId == quizId &&
                        shareId == request.resource.data.sharedWith;

        // Owner can delete their shares, recipient can also delete (to cancel)
        allow delete: if request.auth != null &&
                        (request.auth.uid == resource.data.sharedBy ||
                         request.auth.token.email == resource.data.sharedWith);
      }
    }

    // Game sessions
    match /games/{gameId} {
      // Anyone can read game state
      allow read: if true;

      // Authenticated hosts can create games for their own quizzes OR shared quizzes
      allow create: if request.auth != null &&
                      request.auth.uid == request.resource.data.hostId &&
                      (request.auth.uid == get(/databases/$(database)/documents/quizzes/$(request.resource.data.quizId)).data.hostId ||
                       hasQuizAccess(request.resource.data.quizId));

      // Only the host can update or delete the game
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.hostId;

      // Leaderboard aggregates subcollection
      match /aggregates/{aggId} {
        // Anyone can read aggregates (for host leaderboard display)
        allow read: if true;

        // Only the host can create/update aggregates (initialization from lobby)
        // Cloud Functions also update this using admin SDK
        allow create, update: if request.auth != null &&
                                 request.auth.uid == get(/databases/$(database)/documents/games/$(gameId)).data.hostId;

        // No client-side deletes - cleanup handled by Cloud Functions or game deletion
        allow delete: if false;
      }

      // Player data within a game
      match /players/{playerId} {
        // Anyone can read player data for leaderboards
        allow read: if true;

        // Only allow creating player with initial score of 0, empty answers, and streak 0
        allow create: if request.resource.data.score == 0 &&
                        request.resource.data.id == playerId &&
                        request.resource.data.name is string &&
                        request.resource.data.name.size() >= 2 &&
                        request.resource.data.name.size() <= 20 &&
                        request.resource.data.answers == [] &&
                        request.resource.data.currentStreak == 0;

        // All player updates (score, answers, streak) are handled by Cloud Functions only
        // Cloud Functions use admin privileges and bypass these rules
        allow update: if false;

        // Players cannot be deleted
        allow delete: if false;
      }

      // Question submissions for crowdsourced questions
      match /submissions/{submissionId} {
        // Anyone can read submissions (for display in lobby)
        allow read: if true;

        // Players can create submissions during lobby ONLY if not locked
        // - Game must be in lobby state
        // - Submissions must not be locked (host hasn't clicked "Evaluate")
        // - Player must provide valid data
        // Note: Use .get() with default to safely access nested crowdsourceState.submissionsLocked
        allow create: if get(/databases/$(database)/documents/games/$(gameId)).data.state == 'lobby' &&
                         get(/databases/$(database)/documents/games/$(gameId)).data.get('crowdsourceState', {'submissionsLocked': false}).submissionsLocked != true &&
                         request.resource.data.playerId is string &&
                         request.resource.data.playerName is string &&
                         request.resource.data.questionText is string &&
                         request.resource.data.questionText.size() >= 10 &&
                         request.resource.data.questionText.size() <= 500 &&
                         request.resource.data.answers.size() == 4 &&
                         request.resource.data.correctAnswerIndex >= 0 &&
                         request.resource.data.correctAnswerIndex <= 3;

        // Only host can update submissions (for AI evaluation results)
        allow update: if request.auth != null &&
                         request.auth.uid == get(/databases/$(database)/documents/games/$(gameId)).data.hostId;

        // Deletes handled by Cloud Functions (cleanup on game end/cancel)
        allow delete: if false;
      }
    }
  }
}
