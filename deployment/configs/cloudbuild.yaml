# Cloud Build Pipeline for gQuiz
# This file defines the CI/CD pipeline for automatic deployments
#
# Substitution variables (set by trigger):
#   _ENVIRONMENT: 'dev' or 'production'
#   _FIREBASE_CONFIG: 'firebase.dev.json' or 'firebase.prod.json'
#   _REGION: 'europe-west4'
#   _SERVICE_NAME: 'gquiz-dev' or 'gquiz-prod'

substitutions:
  _ENVIRONMENT: 'dev'
  _FIREBASE_CONFIG: 'firebase.dev.json'
  _REGION: 'europe-west4'
  _SERVICE_NAME: 'gquiz-dev'

steps:
  # ============================================================================
  # Step 1: Install Node.js dependencies
  # ============================================================================
  - name: 'node:20'
    entrypoint: 'npm'
    args: ['ci']
    id: 'install-deps'
    waitFor: ['-']

  # ============================================================================
  # Step 2: Install Cloud Functions dependencies (main + AI in parallel)
  # ============================================================================
  - name: 'node:20'
    entrypoint: 'npm'
    args: ['ci']
    dir: 'functions'
    id: 'install-functions-deps'
    waitFor: ['-']

  - name: 'node:20'
    entrypoint: 'npm'
    args: ['ci']
    dir: 'functions-ai'
    id: 'install-functions-ai-deps'
    waitFor: ['-']

  # ============================================================================
  # Step 3: Build Cloud Functions (main + AI in parallel)
  # ============================================================================
  - name: 'node:20'
    entrypoint: 'npm'
    args: ['run', 'build']
    dir: 'functions'
    id: 'build-functions'
    waitFor: ['install-functions-deps']

  - name: 'node:20'
    entrypoint: 'npm'
    args: ['run', 'build']
    dir: 'functions-ai'
    id: 'build-functions-ai'
    waitFor: ['install-functions-ai-deps']

  # ============================================================================
  # Step 4: Run tests (if available)
  # ============================================================================
  # Uncomment when tests are available
  # - name: 'node:20'
  #   entrypoint: 'npm'
  #   args: ['run', 'test:ci']
  #   id: 'run-tests'
  #   waitFor: ['install-deps']

  # ============================================================================
  # Step 5: Deploy Firestore rules and indexes
  # ============================================================================
  - name: 'node:20'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        npm install -g firebase-tools
        echo "Deploying Firestore rules and indexes to ${PROJECT_ID}..."
        firebase deploy --only firestore --config ${_FIREBASE_CONFIG} --project ${PROJECT_ID} --non-interactive --force
        echo "âœ… Firestore deployed successfully"
    id: 'deploy-firestore'
    waitFor: ['build-functions', 'build-functions-ai']

  # ============================================================================
  # Step 6: Deploy Storage rules
  # ============================================================================
  - name: 'node:20'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        npm install -g firebase-tools
        echo "Deploying Storage rules to ${PROJECT_ID}..."
        firebase deploy --only storage --config ${_FIREBASE_CONFIG} --project ${PROJECT_ID} --non-interactive --force
        echo "âœ… Storage deployed successfully"
    id: 'deploy-storage'
    waitFor: ['deploy-firestore']

  # ============================================================================
  # Step 7: Deploy Cloud Functions (all codebases: default + ai)
  # ============================================================================
  - name: 'node:20'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        npm install -g firebase-tools
        echo "Deploying Cloud Functions to ${PROJECT_ID}..."
        echo "  - Codebase 'default': submitAnswer, createHostAccount, computeQuestionResults, onGameUpdated, onGameDeleted, cleanupOldGames"
        echo "  - Codebase 'ai': generateQuizWithAI, generateQuestionImage, evaluateSubmissions"
        firebase deploy --only functions --config ${_FIREBASE_CONFIG} --project ${PROJECT_ID} --non-interactive --force
        echo "âœ… Cloud Functions deployed successfully (all codebases)"
    id: 'deploy-functions'
    waitFor: ['deploy-storage']

  # ============================================================================
  # Step 7b: Allow unauthenticated access for AI functions (required for CORS)
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Allowing unauthenticated access for AI functions..."
        echo "This is required for CORS preflight requests."
        echo "Security is enforced at the application level (Firebase Auth + App Check)"

        # generateQuizWithAI - AI quiz generation using Gemini 3 Pro
        gcloud functions add-invoker-policy-binding generateQuizWithAI \
          --region=${_REGION} \
          --member="allUsers" \
          --project=${PROJECT_ID} \
          --gen2

        # generateQuestionImage - AI image generation using Gemini 3 Pro Image
        gcloud functions add-invoker-policy-binding generateQuestionImage \
          --region=${_REGION} \
          --member="allUsers" \
          --project=${PROJECT_ID} \
          --gen2

        # evaluateSubmissions - AI evaluation of crowdsourced questions
        gcloud functions add-invoker-policy-binding evaluateSubmissions \
          --region=${_REGION} \
          --member="allUsers" \
          --project=${PROJECT_ID} \
          --gen2

        echo "âœ… AI function invoker policies configured"
    id: 'configure-ai-functions-access'
    waitFor: ['deploy-functions']

  # ============================================================================
  # Step 8: Load environment variables from Secret Manager
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Loading environment variables from Secret Manager..."
        gcloud secrets versions access latest --secret=firebase-config-${_ENVIRONMENT} --project=${PROJECT_ID} > .env.${_ENVIRONMENT}

        # Source the environment file to export variables
        export $(cat .env.${_ENVIRONMENT} | grep -v '^#' | xargs)

        # Save for next steps
        cat .env.${_ENVIRONMENT} > /workspace/env_vars.txt
        echo "âœ… Environment variables loaded"
    id: 'load-env-vars'
    waitFor: ['configure-ai-functions-access']

  # ============================================================================
  # Step 9: Build and deploy to Cloud Run
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Deploying to Cloud Run: ${_SERVICE_NAME} in ${_REGION}..."

        # Load environment variables
        if [ -f /workspace/env_vars.txt ]; then
          export $(cat /workspace/env_vars.txt | grep -v '^#' | xargs)
        fi

        # Deploy to Cloud Run with environment variables
        gcloud run deploy ${_SERVICE_NAME} \
          --source=. \
          --region=${_REGION} \
          --allow-unauthenticated \
          --project=${PROJECT_ID} \
          --platform=managed \
          --memory=512Mi \
          --cpu=1 \
          --timeout=300 \
          --max-instances=10 \
          --min-instances=0 \
          --set-env-vars="NEXT_PUBLIC_FIREBASE_API_KEY=$${NEXT_PUBLIC_FIREBASE_API_KEY}" \
          --set-env-vars="NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=$${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}" \
          --set-env-vars="NEXT_PUBLIC_FIREBASE_PROJECT_ID=$${NEXT_PUBLIC_FIREBASE_PROJECT_ID}" \
          --set-env-vars="NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}" \
          --set-env-vars="NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=$${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}" \
          --set-env-vars="NEXT_PUBLIC_FIREBASE_APP_ID=$${NEXT_PUBLIC_FIREBASE_APP_ID}" \
          --set-env-vars="NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=$${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}" \
          --set-env-vars="NEXT_PUBLIC_ENVIRONMENT=${_ENVIRONMENT}" \
          --set-env-vars="NEXT_PUBLIC_RECAPTCHA_SITE_KEY=$${NEXT_PUBLIC_RECAPTCHA_SITE_KEY}" \
          --update-build-env-vars="NEXT_PUBLIC_FIREBASE_API_KEY=$${NEXT_PUBLIC_FIREBASE_API_KEY}" \
          --update-build-env-vars="NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=$${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}" \
          --update-build-env-vars="NEXT_PUBLIC_FIREBASE_PROJECT_ID=$${NEXT_PUBLIC_FIREBASE_PROJECT_ID}" \
          --update-build-env-vars="NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}" \
          --update-build-env-vars="NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=$${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}" \
          --update-build-env-vars="NEXT_PUBLIC_FIREBASE_APP_ID=$${NEXT_PUBLIC_FIREBASE_APP_ID}" \
          --update-build-env-vars="NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=$${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}" \
          --update-build-env-vars="NEXT_PUBLIC_ENVIRONMENT=${_ENVIRONMENT}" \
          --update-build-env-vars="NEXT_PUBLIC_RECAPTCHA_SITE_KEY=$${NEXT_PUBLIC_RECAPTCHA_SITE_KEY}"

        echo "âœ… Cloud Run deployment successful"
    id: 'deploy-cloud-run'
    waitFor: ['load-env-vars']

  # ============================================================================
  # Step 10: Get and display Cloud Run URL
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "================================================"
        echo "Deployment Summary"
        echo "================================================"
        echo "Environment: ${_ENVIRONMENT}"
        echo "Project: ${PROJECT_ID}"
        echo "Region: ${_REGION}"
        echo "Service: ${_SERVICE_NAME}"
        echo ""

        URL=$(gcloud run services describe ${_SERVICE_NAME} --region=${_REGION} --project=${PROJECT_ID} --format='value(status.url)')
        echo "ðŸŒ Application URL: $$URL"
        echo "$$URL" > /workspace/cloud_run_url.txt

        echo ""
        echo "================================================"
        echo "âœ… Deployment Complete!"
        echo "================================================"
        echo ""
        echo "Next Steps:"
        if [ "${_ENVIRONMENT}" = "dev" ]; then
          echo "1. Test the application at: $$URL"
          echo "2. Check Cloud Functions logs: firebase functions:log --project ${PROJECT_ID}"
          echo "3. If tests pass, merge to main for production deployment"
        else
          echo "1. Verify production deployment: $$URL"
          echo "2. Update CORS origins in Cloud Functions if needed"
          echo "3. Monitor Cloud Run logs: gcloud run services logs read ${_SERVICE_NAME} --region ${_REGION}"
        fi
    id: 'deployment-summary'
    waitFor: ['deploy-cloud-run']

# ============================================================================
# Store deployment artifacts
# ============================================================================
artifacts:
  objects:
    location: 'gs://${PROJECT_ID}_cloudbuild/builds/${BUILD_ID}'
    paths:
      - 'cloud_run_url.txt'
      - 'env_vars.txt'

# ============================================================================
# Build configuration
# ============================================================================
timeout: 1800s  # 30 minutes

options:
  machineType: 'E2_HIGHCPU_8'  # Faster builds with more CPU
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: 'ALLOW_LOOSE'

# Tags for filtering and organizing builds
tags:
  - 'gquiz'
  - '${_ENVIRONMENT}'
  - 'automated-deploy'
